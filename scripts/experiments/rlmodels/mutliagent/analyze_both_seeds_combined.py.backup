"""
Analyze both seed 42 and seed 123 results for discrete models
Report mean ± standard deviation across seeds (standard practice in RL papers)
Success rate = (total cubes picked) / (total episodes * num_cubes per episode)
"""
import pandas as pd
import numpy as np
from pathlib import Path
import matplotlib.pyplot as plt
import seaborn as sns
import matplotlib.font_manager as fm
from scipy.interpolate import make_interp_spline

# Load both seeds
seed_42_csv = Path("cobotproject/scripts/experiments/rlmodels/mutliagent/two_agent_results/discrete/seed_42/episode_results.csv")
seed_123_csv = Path("cobotproject/scripts/experiments/rlmodels/mutliagent/two_agent_results/discrete/seed_123/episode_results.csv")

if not seed_42_csv.exists() or not seed_123_csv.exists():
    print(f"⚠️  Files not found")
    exit()

df_42 = pd.read_csv(seed_42_csv)
df_123 = pd.read_csv(seed_123_csv)

print("="*140)
print("DISCRETE ALGORITHMS - BOTH SEEDS (Mean ± Std)")
print("="*140)
print(f"Seed 42: {len(df_42)} total episodes, {len(df_42) // len(df_42['model'].unique())} episodes per model")
print(f"Seed 123: {len(df_123)} total episodes, {len(df_123) // len(df_123['model'].unique())} episodes per model")
print("="*140)

# Define custom order for models
model_order = [
    'DDQN+MASAC',
    'Heuristic',
    'Duel-DDQN+MASAC',
    'PER-DDQN-Full+MASAC',
    'PER-DDQN-Light+MASAC',
    'C51-DDQN+MASAC',
    'PPO-Discrete+MASAC',
    'SAC-Discrete+MASAC'
]

# Collect results for both seeds
results = []

for model in model_order:
    # Seed 42
    model_df_42 = df_42[df_42['model'] == model]
    num_episodes_42 = len(model_df_42)
    num_cubes_per_episode = model_df_42['num_cubes'].iloc[0]
    
    total_cubes_42 = num_episodes_42 * num_cubes_per_episode
    total_cubes_picked_42 = model_df_42['cubes_picked'].sum()
    success_rate_42 = (total_cubes_picked_42 / total_cubes_42) * 100
    
    if model == 'Heuristic':
        reward_42 = None
    else:
        reward_42 = model_df_42['total_reward'].mean()
    
    distance_42 = model_df_42['total_distance_reduced'].mean()
    time_42 = model_df_42['total_time_saved'].mean()
    
    # Seed 123
    model_df_123 = df_123[df_123['model'] == model]
    num_episodes_123 = len(model_df_123)
    
    total_cubes_123 = num_episodes_123 * num_cubes_per_episode
    total_cubes_picked_123 = model_df_123['cubes_picked'].sum()
    success_rate_123 = (total_cubes_picked_123 / total_cubes_123) * 100
    
    if model == 'Heuristic':
        reward_123 = None
    else:
        reward_123 = model_df_123['total_reward'].mean()
    
    distance_123 = model_df_123['total_distance_reduced'].mean()
    time_123 = model_df_123['total_time_saved'].mean()
    
    # Calculate mean and std across seeds
    success_mean = np.mean([success_rate_42, success_rate_123])
    success_std = np.std([success_rate_42, success_rate_123], ddof=1)  # Sample std
    
    if model == 'Heuristic':
        reward_mean = None
        reward_std = None
    else:
        reward_mean = np.mean([reward_42, reward_123])
        reward_std = np.std([reward_42, reward_123], ddof=1)
    
    distance_mean = np.mean([distance_42, distance_123])
    distance_std = np.std([distance_42, distance_123], ddof=1)
    
    time_mean = np.mean([time_42, time_123])
    time_std = np.std([time_42, time_123], ddof=1)
    
    # Format model name
    if model == 'Heuristic':
        model_name = 'Heuristic'
    elif model == 'DDQN+MASAC':
        model_name = 'DDQN + mGAT'
    else:
        model_name = model.replace('+MASAC', ' + SAC')
    
    results.append({
        'model_name': model_name,
        'reward_mean': reward_mean,
        'reward_std': reward_std,
        'success_mean': success_mean,
        'success_std': success_std,
        'distance_mean': distance_mean,
        'distance_std': distance_std,
        'time_mean': time_mean,
        'time_std': time_std
    })

# Print table
print(f"\n{'Model':<25} {'Reward':>15} {'Pick Success (%)':>25} {'Distance Reduced (m)':>30} {'Time Saved (s)':>30}")
print("-"*140)

for result in results:
    model_name = result['model_name']

    if result['reward_mean'] is None:
        reward_str = "N/A"
    else:
        reward_str = f"{result['reward_mean']:.2f}"

    success_str = f"{result['success_mean']:.2f} ± {result['success_std']:.2f}"
    distance_str = f"{result['distance_mean']:.2f} ± {result['distance_std']:.2f}"
    time_str = f"{result['time_mean']:.2f} ± {result['time_std']:.2f}"

    print(f"{model_name:<25} {reward_str:>15} {success_str:>25} {distance_str:>30} {time_str:>30}")

print("="*140)

# Generate LaTeX table
print("\n" + "="*140)
print("LaTeX TABLE CODE:")
print("="*140)

# Find maximum values for each metric (excluding Heuristic for reward)
max_reward = max([r['reward_mean'] for r in results if r['reward_mean'] is not None])
max_success = max([r['success_mean'] for r in results])
max_distance = max([r['distance_mean'] for r in results])
max_time = max([r['time_mean'] for r in results])

latex_code = """\\begin{table}[h]
\\centering
\\caption{Discrete Algorithm Performance - Mean ± Std across Seeds 42 and 123}
\\label{tab:discrete_both_seeds}
\\begin{tabular}{lcccc}
\\toprule
Model & Reward & Pick Success (\\%) & Distance Reduced (m) & Time Saved (s) \\\\
\\midrule
"""

for result in results:
    model_name = result['model_name']
    is_heuristic = (model_name == 'Heuristic')

    # Reward column
    if result['reward_mean'] is None:
        reward_str = "N/A"
    else:
        reward_val = f"{result['reward_mean']:.2f}"
        if result['reward_mean'] == max_reward or is_heuristic:
            reward_str = f"\\textbf{{{reward_val}}}"
        else:
            reward_str = reward_val

    # Pick Success column
    success_val = f"{result['success_mean']:.2f} $\\pm$ {result['success_std']:.2f}"
    if result['success_mean'] == max_success or is_heuristic:
        success_str = f"\\textbf{{{success_val}}}"
    else:
        success_str = success_val

    # Distance Reduced column
    distance_val = f"{result['distance_mean']:.2f} $\\pm$ {result['distance_std']:.2f}"
    if result['distance_mean'] == max_distance or is_heuristic:
        distance_str = f"\\textbf{{{distance_val}}}"
    else:
        distance_str = distance_val

    # Time Saved column
    time_val = f"{result['time_mean']:.2f} $\\pm$ {result['time_std']:.2f}"
    if result['time_mean'] == max_time or is_heuristic:
        time_str = f"\\textbf{{{time_val}}}"
    else:
        time_str = time_val

    latex_code += f"{model_name} & {reward_str} & {success_str} & {distance_str} & {time_str} \\\\\n"

latex_code += """\\bottomrule
\\end{tabular}
\\end{table}"""

print(latex_code)
print("="*140)

# ============================================================================
# BAR GRAPH: Reward by Episode
# ============================================================================

# Filter models to include only DDQN + mGAT, Duel-DDQN + SAC, and PER-DDQN-Full + SAC
models_to_plot = ['DDQN+MASAC', 'Duel-DDQN+MASAC', 'PER-DDQN-Full+MASAC']
model_display_names = {
    'DDQN+MASAC': 'DDQN + mGAT',
    'Duel-DDQN+MASAC': 'Duel-DDQN + SAC',
    'PER-DDQN-Full+MASAC': 'PER-DDQN-Full + SAC'
}

# Combine data from both seeds
df_combined = pd.concat([df_42, df_123], ignore_index=True)

# Filter for selected models
df_plot = df_combined[df_combined['model'].isin(models_to_plot)].copy()

# Map model names to display names
df_plot['model_display'] = df_plot['model'].map(model_display_names)

# Filter for episodes 2, 4, 6, 8, 10, 12, 14, 16
episodes_to_plot = [2, 4, 6, 8, 10, 12, 14, 16]
df_filtered = df_plot[df_plot['episode'].isin(episodes_to_plot)].copy()

# Calculate average reward for each model at each episode (across both seeds)
df_grouped = df_filtered.groupby(['model_display', 'episode'])['total_reward'].mean().reset_index()

# Set up seaborn theme
sns.set_theme(style="whitegrid")

# Set up Linux Libertine font
plt.rcParams['font.family'] = 'Linux Libertine'
plt.rcParams['font.size'] = 20

# Define custom color palette based on the image: slate blue, light green, turquoise
custom_colors = ['#5B7C99', '#90EE90', '#40E0D0']

# Create figure with larger size
fig, ax = plt.subplots(figsize=(14, 9))

# Create bar plot with doubled bar width
bar_plot = sns.barplot(
    data=df_grouped,
    x='episode',
    y='total_reward',
    hue='model_display',
    palette=custom_colors,
    ax=ax,
    width=0.8
)

# Customize grid - solid lines, thicker, more visible
ax.grid(True, linestyle='-', linewidth=1.5, alpha=0.7)
ax.set_axisbelow(True)

# Set labels and title with bold and doubled font size
ax.set_xlabel('Episode', fontsize=20, fontweight='bold')
ax.set_ylabel('Reward', fontsize=20, fontweight='bold')
ax.set_title('Reward by episode', fontsize=20, fontweight='bold')

# Customize legend - doubled size
ax.legend(title='', fontsize=16, frameon=True, loc='lower right')

# Set x-axis ticks and labels
ax.set_xticks(range(len(episodes_to_plot)))
ax.set_xticklabels(episodes_to_plot, fontsize=20)

# Set y-axis tick label font size
ax.tick_params(axis='y', labelsize=20)

# Add value labels on top of bars
for container in ax.containers:
    ax.bar_label(container, fontsize=14, padding=3, fmt='%.0f')

# Tight layout
plt.tight_layout()

# Save figure
output_path = Path("cobotproject/scripts/experiments/rlmodels/mutliagent/two_agent_results/discrete/reward_by_episode.png")
output_path.parent.mkdir(parents=True, exist_ok=True)
plt.savefig(output_path, dpi=300, bbox_inches='tight')
print(f"\n✓ Bar graph saved to: {output_path}")
plt.close()

# ============================================================================
# LINE CHART: Pick Success (%) by Episode
# ============================================================================

# Filter models to include only DDQN + mGAT and Heuristic
models_to_plot_success = ['DDQN+MASAC', 'Heuristic']
model_display_names_success = {
    'DDQN+MASAC': 'DDQN + mGAT',
    'Heuristic': 'Heuristic'
}

# Filter for selected models
df_plot_success = df_combined[df_combined['model'].isin(models_to_plot_success)].copy()

# Map model names to display names
df_plot_success['model_display'] = df_plot_success['model'].map(model_display_names_success)

# Filter for all episodes from 1 to 17
all_episodes = list(range(1, 18))
df_filtered_success = df_plot_success[df_plot_success['episode'].isin(all_episodes)].copy()

# Calculate success rate for each model at each episode
df_filtered_success['num_cubes'] = df_filtered_success['num_cubes'].astype(int)
df_filtered_success['success_rate'] = (df_filtered_success['cubes_picked'] / df_filtered_success['num_cubes']) * 100

# Calculate average success rate across both seeds
df_grouped_success = df_filtered_success.groupby(['model_display', 'episode'])['success_rate'].mean().reset_index()

# Set up seaborn theme
sns.set_theme(style="whitegrid")

# Set up Linux Libertine font
plt.rcParams['font.family'] = 'Linux Libertine'
plt.rcParams['font.size'] = 10

# Define custom color palette: cyan for DDQN + mGAT, coral/salmon for Heuristic
custom_colors_success = {
    'DDQN + mGAT': '#00CED1',  # cyan/turquoise
    'Heuristic': '#FF6B6B'  # coral/salmon red
}

# Define markers
markers_success = {
    'DDQN + mGAT': 'o',  # circle
    'Heuristic': 'x'  # cross
}

# Create figure with larger size
fig, ax = plt.subplots(figsize=(14, 9))

# Create line plot without smoothing
for model in ['DDQN + mGAT', 'Heuristic']:
    model_data = df_grouped_success[df_grouped_success['model_display'] == model].sort_values('episode')

    # Get x and y data
    x = model_data['episode'].values
    y = model_data['success_rate'].values

    # Plot line with markers at each episode
    ax.plot(x, y, color=custom_colors_success[model], linewidth=4,
            label=model, marker=markers_success[model], markersize=10, markevery=1)

# Customize grid - solid lines, thicker, more visible
ax.grid(True, linestyle='-', linewidth=1.5, alpha=0.7)
ax.set_axisbelow(True)

# Set labels and title with bold and doubled font size
ax.set_xlabel('Episode', fontsize=20, fontweight='bold')
ax.set_ylabel('Pick success (%)', fontsize=20, fontweight='bold')
ax.set_title('Pick success by models', fontsize=20, fontweight='bold')

# Customize legend - doubled size
ax.legend(fontsize=16, frameon=True, loc='lower right')

# Set x-axis ticks to show 0, 2, 4, 6, 8, 10, 12, 14, 16, 18
x_ticks_display = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18]
ax.set_xticks(x_ticks_display)
ax.set_xticklabels(x_ticks_display, fontsize=20)

# Set y-axis range and ticks (adjusted to show data better)
ax.set_ylim(60, 105)
ax.set_yticks([60, 65, 70, 75, 80, 85, 90, 95, 100])
ax.tick_params(axis='y', labelsize=20)

# Set x-axis limits to start from 1
ax.set_xlim(1, 17)

# Tight layout
plt.tight_layout()

# Save figure
output_path_success = Path("cobotproject/scripts/experiments/rlmodels/mutliagent/two_agent_results/discrete/pick_success_by_episode.png")
output_path_success.parent.mkdir(parents=True, exist_ok=True)
plt.savefig(output_path_success, dpi=300, bbox_inches='tight')
print(f"✓ Line chart saved to: {output_path_success}")
plt.close()

# ============================================================================
# LINE CHART: Distance Reduced (m) by Episode
# ============================================================================

# Filter models to include only DDQN + mGAT and Heuristic
models_to_plot_distance = ['DDQN+MASAC', 'Heuristic']
model_display_names_distance = {
    'DDQN+MASAC': 'DDQN + mGAT',
    'Heuristic': 'Heuristic'
}

# Filter for selected models
df_plot_distance = df_combined[df_combined['model'].isin(models_to_plot_distance)].copy()

# Map model names to display names
df_plot_distance['model_display'] = df_plot_distance['model'].map(model_display_names_distance)

# Filter for all episodes from 1 to 17
df_filtered_distance = df_plot_distance[df_plot_distance['episode'].isin(all_episodes)].copy()

# Calculate average distance reduced across both seeds
df_grouped_distance = df_filtered_distance.groupby(['model_display', 'episode'])['total_distance_reduced'].mean().reset_index()

# Set up seaborn theme
sns.set_theme(style="whitegrid")

# Set up Linux Libertine font
plt.rcParams['font.family'] = 'Linux Libertine'
plt.rcParams['font.size'] = 10

# Use same colors as pick success chart
custom_colors_distance = {
    'DDQN + mGAT': '#00CED1',  # cyan/turquoise
    'Heuristic': '#FF6B6B'  # coral/salmon red
}

# Define markers
markers_distance = {
    'DDQN + mGAT': 'o',  # circle
    'Heuristic': 'x'  # cross
}

# Create figure with larger size
fig, ax = plt.subplots(figsize=(14, 9))

# Create line plot without smoothing
for model in ['DDQN + mGAT', 'Heuristic']:
    model_data = df_grouped_distance[df_grouped_distance['model_display'] == model].sort_values('episode')

    # Get x and y data
    x = model_data['episode'].values
    y = model_data['total_distance_reduced'].values

    # Plot line with markers at each episode
    ax.plot(x, y, color=custom_colors_distance[model], linewidth=4,
            label=model, marker=markers_distance[model], markersize=10, markevery=1)

# Customize grid - solid lines, thicker, more visible
ax.grid(True, linestyle='-', linewidth=1.5, alpha=0.7)
ax.set_axisbelow(True)

# Set labels and title with bold and doubled font size
ax.set_xlabel('Episode', fontsize=20, fontweight='bold')
ax.set_ylabel('Distance reduced (m)', fontsize=20, fontweight='bold')
ax.set_title('Distance reduced by models', fontsize=20, fontweight='bold')

# Customize legend - doubled size
ax.legend(fontsize=16, frameon=True, loc='lower right')

# Set x-axis ticks to show 0, 2, 4, 6, 8, 10, 12, 14, 16, 18
ax.set_xticks(x_ticks_display)
ax.set_xticklabels(x_ticks_display, fontsize=20)

# Set y-axis tick label font size
ax.tick_params(axis='y', labelsize=20)

# Set x-axis limits to start from 1
ax.set_xlim(1, 17)

# Tight layout
plt.tight_layout()

# Save figure
output_path_distance = Path("cobotproject/scripts/experiments/rlmodels/mutliagent/two_agent_results/discrete/distance_reduced_by_episode.png")
output_path_distance.parent.mkdir(parents=True, exist_ok=True)
plt.savefig(output_path_distance, dpi=300, bbox_inches='tight')
print(f"✓ Line chart saved to: {output_path_distance}")
plt.close()

# ============================================================================
# LINE CHART: Time Saved (s) by Episode
# ============================================================================

# Filter models to include only DDQN + mGAT and Heuristic
models_to_plot_time = ['DDQN+MASAC', 'Heuristic']
model_display_names_time = {
    'DDQN+MASAC': 'DDQN + mGAT',
    'Heuristic': 'Heuristic'
}

# Filter for selected models
df_plot_time = df_combined[df_combined['model'].isin(models_to_plot_time)].copy()

# Map model names to display names
df_plot_time['model_display'] = df_plot_time['model'].map(model_display_names_time)

# Filter for all episodes from 1 to 17
df_filtered_time = df_plot_time[df_plot_time['episode'].isin(all_episodes)].copy()

# Calculate average time saved across both seeds
df_grouped_time = df_filtered_time.groupby(['model_display', 'episode'])['total_time_saved'].mean().reset_index()

# Set up seaborn theme
sns.set_theme(style="whitegrid")

# Set up Linux Libertine font
plt.rcParams['font.family'] = 'Linux Libertine'
plt.rcParams['font.size'] = 10

# Use same colors as pick success chart
custom_colors_time = {
    'DDQN + mGAT': '#00CED1',  # cyan/turquoise
    'Heuristic': '#FF6B6B'  # coral/salmon red
}

# Define markers
markers_time = {
    'DDQN + mGAT': 'o',  # circle
    'Heuristic': 'x'  # cross
}

# Create figure with larger size
fig, ax = plt.subplots(figsize=(14, 9))

# Create line plot without smoothing
for model in ['DDQN + mGAT', 'Heuristic']:
    model_data = df_grouped_time[df_grouped_time['model_display'] == model].sort_values('episode')

    # Get x and y data
    x = model_data['episode'].values
    y = model_data['total_time_saved'].values

    # Plot line with markers at each episode
    ax.plot(x, y, color=custom_colors_time[model], linewidth=4,
            label=model, marker=markers_time[model], markersize=10, markevery=1)

# Customize grid - solid lines, thicker, more visible
ax.grid(True, linestyle='-', linewidth=1.5, alpha=0.7)
ax.set_axisbelow(True)

# Set labels and title with bold and doubled font size
ax.set_xlabel('Episode', fontsize=20, fontweight='bold')
ax.set_ylabel('Time saved (s)', fontsize=20, fontweight='bold')
ax.set_title('Time saved by models', fontsize=20, fontweight='bold')

# Customize legend - doubled size
ax.legend(fontsize=16, frameon=True, loc='lower right')

# Set x-axis ticks to show 0, 2, 4, 6, 8, 10, 12, 14, 16, 18
ax.set_xticks(x_ticks_display)
ax.set_xticklabels(x_ticks_display, fontsize=20)

# Set y-axis tick label font size
ax.tick_params(axis='y', labelsize=20)

# Set x-axis limits to start from 1
ax.set_xlim(1, 17)

# Tight layout
plt.tight_layout()

# Save figure
output_path_time = Path("cobotproject/scripts/experiments/rlmodels/mutliagent/two_agent_results/discrete/time_saved_by_episode.png")
output_path_time.parent.mkdir(parents=True, exist_ok=True)
plt.savefig(output_path_time, dpi=300, bbox_inches='tight')
print(f"✓ Line chart saved to: {output_path_time}")
plt.close()

